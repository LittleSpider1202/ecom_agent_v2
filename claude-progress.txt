# Claude Progress Log

## Session 1 — Initializer Agent (2026-02-25)

### 完成内容

1. **feature_list.json 生成完毕**
   - 共 231 条测试用例（超过要求的 200 条）
   - functional: 189 条，style: 42 条
   - 25 条有 10+ 步骤的端到端测试（满足"至少25条"要求）
   - 覆盖所有页面：EW-01~10, MW-01~15, BOT-01~05
   - 全部 passes: false

2. **init.sh 创建完毕**
   - 启动后端 FastAPI（port 8000）
   - 启动前端 React dev server（port 3000）
   - 数据库在小主机运行（192.168.0.112）

3. **项目目录结构初始化**
   - backend/: FastAPI 后端骨架（main.py, requirements.txt, .env.example）
   - frontend/: React + TypeScript + Tailwind + Vite 骨架（带路由占位页）
   - tests/: Playwright E2E 测试配置
   - verification/: 测试截图存档目录（空）

4. **前端路由结构**
   - 已配置所有 25 个页面的路由（EW-01~10, MW-01~15）
   - 当前为 Placeholder 占位页，等待逐步实现

---

## Session 2 — 认证模块（2026-02-25）

### 完成内容

1. **后端认证模块实现**
   - `backend/database.py`：SQLAlchemy engine + SessionLocal + Settings（pydantic-settings）
   - `backend/models.py`：User 表（id, username, email, hashed_password, display_name, role, is_active, created_at）
   - `backend/auth.py`：JWT 创建/验证、密码哈希（直接用 bcrypt，不用 passlib）、get_current_user / require_current_user
   - `backend/routers/auth.py`：POST /api/auth/login、GET /api/auth/me、POST /api/auth/logout
   - `backend/main.py`：集成以上模块，startup 事件自动创建 3 个默认用户

2. **前端认证模块实现**
   - `frontend/src/contexts/AuthContext.tsx`：AuthProvider + useAuth hook，JWT 存入 localStorage
   - `frontend/src/pages/Login.tsx`：登录页面（表单 + 错误提示）
   - `frontend/src/components/PrivateRoute.tsx`：路由保护（未登录→/login；executor→拒绝访问/manage/*）
   - `frontend/src/components/AppLayout.tsx`：顶部导航栏（显示用户名 + 退出登录 hover 菜单）
   - `frontend/src/App.tsx`：已更新，所有路由用 ProtectedLayout 包裹，/manage/* 限 manager 角色

3. **Playwright 测试（已通过）**
   - tests/feature-161~164.spec.ts：登录/密码错误/会话保持/退出

---

## Session 3 — EW-01/EW-02 + 测试验证（2026-02-26）

### 完成内容

1. **EW-01 我的看板 + EW-02 任务列表**
   - `backend/models.py`：新增 TaskInstance 表
   - `backend/routers/tasks.py`：GET /api/tasks/my + GET /api/tasks
   - `frontend/src/pages/executor/Dashboard.tsx`：EW-01
   - `frontend/src/pages/executor/TaskList.tsx`：EW-02

2. **测试全部通过（14/14）**
   - feature #1-10（EW-01/02）passes: true
   - feature #161-164（认证）passes: true
   - 截图存入 tests/verification/

3. **小主机部署完成**
   - 后端：uvicorn 跑在宿主机 `0.0.0.0:8002`（后台 nohup）
   - 前端：构建后 `docker cp` 进现有 nginx 容器
   - nginx：`/api/` 反代 `172.17.0.1:8002`，`/` 走 SPA
   - 访问地址：**http://192.168.0.112**

4. **新增部署相关文件**
   - `backend/Dockerfile` + `backend/requirements-prod.txt`
   - `frontend/Dockerfile` + `frontend/nginx.conf`
   - `docker-compose.yml`（完整栈，当前小主机用现有容器替代）
   - `frontend/src/vite-env.d.ts`（修复构建 TS 报错）
   - `CLAUDE.md`：新增"部署规范"章节，要求依赖变更同步 Dockerfile

### 当前 passes: true 的 feature（共 14 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #161-164（用户认证）

---

## Session 5 — EW-04 人工操作步骤（2026-02-26）

### 完成内容

1. **后端 TaskStep 模型 + API**
   - `backend/models.py`：新增 `TaskStep` 表（task_id, step_name, background_info, instructions, ai_suggestion, status, final_content, reject_reason）
   - `backend/routers/tasks.py`：新增 3 个 endpoints：
     - `GET /api/tasks/{task_id}/steps/{step_id}`（step_id 支持 "current" 或数字 ID）
     - `POST /api/tasks/{task_id}/steps/{step_id}/submit`（mode: accept|modify）
     - `POST /api/tasks/{task_id}/steps/{step_id}/reject`
   - `backend/main.py`：startup 事件新增 5 条 TaskStep 种子数据

2. **前端 EW-04 页面**
   - `frontend/src/pages/executor/HumanStep.tsx`：完整人工步骤页面
     - 背景信息、操作说明、AI建议（可编辑 textarea）
     - 红色"提交后不可撤回"警告横幅
     - 三按钮：全部采纳AI建议 / 修改后提交 / 驳回
     - 确认对话框（accept/modify/reject 三种）
     - 表单验证（AI建议不能为空）
   - `frontend/src/App.tsx`：路由 `/task/:taskId/step/:stepId` → HumanStep
   - `frontend/src/pages/executor/TaskList.tsx`：添加 has_human_step 字段，点击跳转到人工步骤页

3. **测试全部通过（9/9）**
   - feature #17-25（EW-04）passes: true
   - 截图存入 verification/

### 当前 passes: true 的 feature（共 23 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #17-25（EW-04 人工操作步骤）
- #161-164（用户认证）

---

## Session 6 — MW-01 决策驾驶舱（2026-02-26）

### 完成内容

1. **后端 AISuggestion 模型 + API**
   - `backend/models.py`：新增 `AISuggestion` 表（title, summary, content, category, status）
   - `backend/routers/dashboard.py`：GET /api/dashboard（health_score + ai_suggestions + active_tasks）、GET /api/suggestions/{id}
   - `backend/main.py`：3 条 AISuggestion 种子数据 + dev-reset 逻辑（每次重启还原 TaskStep/TaskInstance 状态）

2. **前端 MW-01 页面**
   - `frontend/src/pages/manager/DecisionCockpit.tsx`：SVG 圆形仪表盘 + AI建议列表 + 活动任务摘要
   - `frontend/src/pages/manager/SuggestionDetail.tsx`：建议详情页（面包屑 + 完整内容）
   - `frontend/src/App.tsx`：替换 /manage/dashboard 和 /manage/suggestions/:id 的 Placeholder

3. **测试全部通过（5/5）**
   - feature #26-30（MW-01）passes: true
   - 截图存入 tests/verification/

4. **修复**
   - 回归 bug：TaskInstance.status 未重置导致 pending 任务不出现 → startup 同时重置 task status
   - deploy.sh 遗漏 dashboard.py → 补充 scp 条目

### 当前 passes: true 的 feature（共 28 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #161-164（用户认证）

---

## Session 7 — MW-03 流程编辑器（2026-02-27）

### 完成内容

1. **后端 Flow/FlowVersion 模型 + API**
   - `backend/models.py`：新增 `Flow`（JSON nodes/edges）、`FlowVersion`
   - `backend/routers/flows.py`：`GET/POST /api/flows`、`GET/PUT /api/flows/{id}`、`POST /api/flows/{id}/trigger`、`GET /api/flows/{id}/versions`、`POST /api/flows/generate`（mock AI）
   - `backend/routers/tasks.py`：新增 `GET /api/tasks/monitor` 全局监控
   - `backend/main.py`：集成 flows router

2. **前端 ReactFlow 编辑器**
   - `frontend/src/pages/manager/FlowEditor.tsx`：完整流程编辑器
     - 使用 `@xyflow/react` (v12)，ReactFlowProvider 包裹
     - 3种节点：AutoNode(蓝)、HumanNode(橙)、ConditionNode(菱形/紫)
     - 节点面板：点击或拖拽添加；Delete键删除；双击打开配置面板
     - AI生成（mock）、保存/版本（v1→v2）、手动触发
   - `frontend/src/pages/manager/FlowVersions.tsx`：版本历史页
   - `frontend/src/pages/manager/TaskMonitor.tsx`：全局任务监控页
   - `frontend/src/App.tsx`：替换3个Placeholder路由

3. **测试全部通过（12/12）**
   - feature #31-42（MW-03）passes: true
   - 采用 API 登录（programmatic，直接写 localStorage）避免 UI 登录 flakiness

4. **小主机部署**：bash deploy.sh（含 flows.py scp）

### 当前 passes: true 的 feature（共 40 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #31-42（MW-03 流程编辑器）
- #161-164（用户认证）

---

## Session 8 — Style 测试 #43-50（2026-02-27）

### 完成内容

1. **Style 测试 #43-50 全部通过（8/8）**
   - `tests/feature-043.spec.ts`：8条测试
   - #43: EW-01 看板 — 无水平滚动 + 两列布局
   - #44: EW-01 看板卡片 — 标题/徽章/颜色
   - #45: EW-02 任务列表 — pending 徽章颜色为黄色(bg-yellow-100)
   - #46: EW-04 人工步骤 — 红色 warning-banner + 区域分离
   - #47: MW-01 决策驾驶舱 — 健康分数大字 + inline color style
   - #48: MW-03 流程编辑器 — auto=bg-blue-50, human=bg-orange-50
   - #49: MW-03 流程编辑器布局 — panel 左侧，canvas 主区，toolbar 顶部
   - #50: MW-03 cron触发 — 保存后重载验证persistence

2. **关键踩坑**
   - `/api/tasks/my` 返回 `{pending:[...], running:[...]}` 不是平铺数组
   - 健康分值颜色用 `style={{ color }}` inline，不是 Tailwind class
   - task row click 导航到 EW-03 而非 HumanStep（因 has_human_step 检查）→ 直接 navigate 到 `/task/1/step/current`

### 当前 passes: true 的 feature（共 48 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #31-42（MW-03 流程编辑器）
- #43-50（Style 测试）
- #161-164（用户认证）

---

## Session 9 — EW-03 任务详情（自动）（2026-02-27）

### 完成内容

1. **后端 TaskDagNode 模型 + API**
   - `backend/models.py`：新增 `TaskDagNode` 表（task_id, node_key, label, node_type, status, log, pos_x, pos_y, source_keys, error_msg）
   - `backend/routers/tasks.py`：新增 `GET /api/tasks/{id}/dag`（返回 nodes + 推导出的 edges）
   - `backend/main.py`：导入 TaskDagNode，为"618大促活动方案执行"任务种子5条 DAG 节点

2. **前端 EW-03 页面**
   - `frontend/src/pages/executor/TaskDetail.tsx`：完整任务详情页
     - ReactFlow read-only DAG 视图（nodesDraggable=false, nodesConnectable=false）
     - 节点颜色：completed=green+✓, running=blue+animate-pulse, failed=red+×, pending=gray
     - 点击节点弹出右侧日志面板（data-testid="log-panel"）
     - 日志面板有关闭按钮（data-testid="log-panel-close"）
   - `frontend/src/App.tsx`：/executor/tasks/:taskId 路由替换 TaskDetail
   - `tests/feature-011.spec.ts`：#11-16 全部通过（6/6）

3. **关键踩坑**
   - ReactFlow pane 拦截 Playwright 鼠标点击 → 用 `page.evaluate` dispatch MouseEvent
   - SVG edge `<g>` 元素 toBeVisible 报 hidden → 改用 count() 验证
   - Node.js 上下文无 localStorage → 用 `page.request.post()` 重新登录获取 token

### 当前 passes: true 的 feature（共 54 条）
- #1-10（EW-01 看板 + EW-02 任务列表）
- #11-16（EW-03 任务详情）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #31-42（MW-03 流程编辑器）
- #43-50（Style 测试）
- #161-164（用户认证）

---

## Session 10 — EW-05 任务历史（2026-02-27）

### 完成内容

1. **后端 TaskInstance.completed_at 字段**
   - 新增字段（`ALTER TABLE ... ADD COLUMN IF NOT EXISTS` 兼容迁移）
   - startup 自动补填历史任务的 completed_at（`created_at + 6h`）

2. **新增 API 端点**
   - `GET /api/tasks/history`：已完成/失败/驳回任务，支持搜索+日期范围筛选+分页
   - `GET /api/tasks/my-steps`：当前用户处理过的所有步骤（带操作类型）

3. **前端 EW-05 页面**
   - `frontend/src/pages/executor/TaskHistory.tsx`：两个 Tab
     - "已完成任务"：列表（流程名、状态徽章、完成时间 YYYY-MM-DD HH:mm、耗时）+ 搜索+日期筛选
     - "我的操作记录"：步骤历史（操作类型：采纳/修改/驳回，颜色区分）
   - `frontend/src/App.tsx`：替换 /executor/history Placeholder

4. **测试全部通过（6/6）**
   - features #51-55, #92 passes: true
   - 截图存入 verification/

### 关键踩坑
- Playwright 搜索测试：用 `waitForResponse` 而非 `waitForTimeout(500)` 来确保 API 响应到达

### 当前 passes: true 的 feature（共 60 条）
- #1-10（EW-01/EW-02）
- #11-16（EW-03 任务详情）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #31-42（MW-03 流程编辑器）
- #43-50（Style 测试）
- #51-55, #92（EW-05 任务历史）
- #161-164（用户认证）

---

## Session 11 — MW-02 流程定义列表（2026-02-27）

### 完成内容

1. **后端 `flows.py` 扩展**
   - `GET /api/flows` 新增 `success_rate`、`avg_duration`、`is_enabled` 字段（从 TaskInstance 聚合计算）
   - 支持 `?search=` query param 按名称过滤
   - 新增 `PATCH /api/flows/{id}/toggle` 端点（在 "active"/"inactive" 间切换）

2. **后端 `main.py` 种子数据**
   - 新增 10 条 Flow 种子（名称与 TaskInstance.flow_name 匹配）
   - 条件：`if not db.query(Flow).filter(Flow.name == "采购审核流程").first():` 防重复

3. **前端 FlowList.tsx**
   - 路由：`/manage/flows`
   - 搜索框 + 流程卡片列表（name, version, trigger_type, 状态）
   - 健康指标（success_rate %, avg_duration 分钟）
   - 健康颜色指示器：绿(>=80%), 黄(>=50%), 红(<50%)
   - 启用/禁用开关（toggle）
   - "新建流程"按钮 → /manage/flows/new

4. **测试全部通过（6/6）**
   - features #76-80, #96 passes: true
   - 截图存入 verification/

### 关键踩坑
- Flow 种子条件判断不能用 count()==0（表已有 14 条测试数据）
- ReactFlow 严格模式：`.react-flow` 匹配 19 个元素 → 用 `getByTestId('rf__wrapper')`

### 当前 passes: true 的 feature（共 66 条）
- #1-10（EW-01/EW-02）
- #11-16（EW-03 任务详情）
- #17-25（EW-04 人工操作步骤）
- #26-30（MW-01 决策驾驶舱）
- #31-42（MW-03 流程编辑器）
- #43-50（Style 测试）
- #51-55, #92（EW-05 任务历史）
- #76-80, #96（MW-02 流程定义列表）
- #161-164（用户认证）

---

## Session 12 — 下次从这里开始

### 启动步骤

```bash
# 1. 本地后端
cd backend
NO_PROXY="localhost,127.0.0.1" .venv/Scripts/uvicorn.exe main:app --port 8001

# 2. 本地前端
cd frontend
NO_PROXY="localhost,127.0.0.1" npm run dev -- --port 3000

# 3. 回归测试
cd tests
NO_PROXY="localhost,127.0.0.1" npx playwright test feature-001.spec.ts feature-076.spec.ts feature-161.spec.ts --reporter=list
```

### 关键约束提醒

- Flow 种子条件：用 `filter(Flow.name == "采购审核流程").first()` 判断，不用 count()==0
- ReactFlow 根节点测试：用 `getByTestId('rf__wrapper')` 而非 `.react-flow`（多元素）
- `@xyflow/react` v12：handle属性用 `data-handlepos` 不是 `data-handletype`
- 登录测试用 API 登录（`page.request.post` + 写 localStorage），不用 UI 表单
- token 在 localStorage 存储 key 是 `auth_token`

### 启动步骤

```bash
# 1. 本地后端
cd backend
NO_PROXY="localhost,127.0.0.1" .venv/Scripts/uvicorn.exe main:app --port 8001

# 2. 本地前端
cd frontend
NO_PROXY="localhost,127.0.0.1" npm run dev -- --port 3000

# 3. 回归测试
cd tests
NO_PROXY="localhost,127.0.0.1" npx playwright test feature-001.spec.ts feature-051.spec.ts feature-161.spec.ts --reporter=list
```

### 启动步骤

```bash
# 1. 本地后端
cd backend
NO_PROXY="localhost,127.0.0.1" .venv/Scripts/uvicorn.exe main:app --port 8001

# 2. 本地前端
cd frontend
NO_PROXY="localhost,127.0.0.1" npm run dev -- --port 3000

# 3. 回归测试
cd tests
NO_PROXY="localhost,127.0.0.1" npx playwright test feature-001.spec.ts feature-031.spec.ts feature-161.spec.ts --reporter=list
```

### 关键约束提醒

- `@xyflow/react` v12：handle属性用 `data-handlepos` 不是 `data-handletype`
- 登录测试用 API 登录（`page.request.post` + 写 localStorage），不用 UI 表单
- token 在 localStorage 存储 key 是 `auth_token`，不是 `token`
- 每次新增 router，deploy.sh scp 列表同步更新

### 下一个任务：MW-03 流程编辑器（feature #31-50）

### 启动步骤

```bash
# 1. 本地后端（开发测试用）
cd backend
.venv/Scripts/activate
NO_PROXY="localhost,127.0.0.1" uvicorn main:app --reload --port 8001

# 2. 本地前端（必须加 NO_PROXY）
cd frontend
NO_PROXY="localhost,127.0.0.1" npm run dev -- --port 3000

# 3. 运行回归测试（确认没有引入问题）
cd tests
NO_PROXY="localhost,127.0.0.1" npx playwright test feature-001.spec.ts feature-017.spec.ts feature-161.spec.ts --reporter=list

# 4. 开发新 feature，完成后运行对应测试
NO_PROXY="localhost,127.0.0.1" npx playwright test feature-026.spec.ts --reporter=list
```

### 小主机部署注意事项

- 小主机无法访问 GitHub，代码更新需从本地 SCP 传输
- 后端以 nohup 运行，PID 见 `ps aux | grep uvicorn`
- 前端更新：本地 `npm run build`，然后 `docker cp dist/. nginx:/usr/share/nginx/html/`
- nginx 配置已改为反代 8002（v2），v1 在 8000（勿动）
- ufw 已开放：8002（v2 后端）

### 关键约束提醒

- vite.config.ts proxy 目前指向 `localhost:8001`（本地开发）
- 部署用 `npm run build` 静态构建，proxy 不生效，由 nginx 处理
- 每次新增 Python 依赖必须同步更新 `backend/requirements-prod.txt` 和 `backend/Dockerfile`
